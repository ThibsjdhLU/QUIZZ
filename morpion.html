<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jeu de Morpion</title>
    <meta name="description" content="Jeu de morpion (Tic‚ÄëTac‚ÄëToe) contre l'IA" />
    <link rel="icon" href="assets/favicon.svg">
    <link rel="stylesheet" href="assets/site.css">
  </head>
  <body>
    <header class="site">
      <div class="left"><a class="btn ghost" href="index.html">‚Üê Accueil</a></div>
      <h1>Morpion</h1>
      <div class="right"><button id="theme-toggle" class="theme-toggle" aria-label="Changer de th√®me">üåô</button></div>
    </header>
    <main class="ttt-wrap">
      <div class="ad-wrap" aria-label="Publicit√©">
        <small class="ad-label">Publicit√©</small>
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-XXXXXXXXXXXXXXXX" data-ad-slot="1000000001" data-ad-format="auto" data-full-width-responsive="true"></ins>
      </div>
      <p id="status" class="ttt-status" aria-live="polite">Votre tour (X)</p>
      <div class="ttt-board-wrap">
        <div class="ttt-board" id="board" role="grid" aria-label="Morpion">
          <button class="ttt-cell" role="gridcell" aria-label="case 1" data-index="0"></button>
          <button class="ttt-cell" role="gridcell" aria-label="case 2" data-index="1"></button>
          <button class="ttt-cell" role="gridcell" aria-label="case 3" data-index="2"></button>
          <button class="ttt-cell" role="gridcell" aria-label="case 4" data-index="3"></button>
          <button class="ttt-cell" role="gridcell" aria-label="case 5" data-index="4"></button>
          <button class="ttt-cell" role="gridcell" aria-label="case 6" data-index="5"></button>
          <button class="ttt-cell" role="gridcell" aria-label="case 7" data-index="6"></button>
          <button class="ttt-cell" role="gridcell" aria-label="case 8" data-index="7"></button>
          <button class="ttt-cell" role="gridcell" aria-label="case 9" data-index="8"></button>
        </div>
        <div id="win-line" class="ttt-line" aria-hidden="true"></div>
      </div>
      <div class="ttt-controls">
        <div class="seg" role="group" aria-label="Difficult√©">
          <input type="radio" id="diff-easy" name="diff" value="easy"><label for="diff-easy">Facile</label>
          <input type="radio" id="diff-normal" name="diff" value="normal" checked><label for="diff-normal">Normal</label>
          <input type="radio" id="diff-hard" name="diff" value="hard"><label for="diff-hard">Imbattable</label>
        </div>
        <div class="seg" role="group" aria-label="Symbole">
          <input type="radio" id="sym-x" name="sym" value="X" checked><label for="sym-x">Vous: X</label>
          <input type="radio" id="sym-o" name="sym" value="O"><label for="sym-o">Vous: O</label>
        </div>
        <label><input type="checkbox" id="ia-starts"> L‚ÄôIA commence</label>
        <button id="reset" type="button" class="btn">Rejouer</button>
      </div>
      <div class="score" id="score">
        <span class="badge">Victoires: <strong id="wins">0</strong></span>
        <span class="badge">D√©faites: <strong id="losses">0</strong></span>
        <span class="badge">√âgalit√©s: <strong id="draws">0</strong></span>
      </div>
      <div class="ad-wrap" aria-label="Publicit√©">
        <small class="ad-label">Publicit√©</small>
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-XXXXXXXXXXXXXXXX" data-ad-slot="1000000002" data-ad-format="auto" data-full-width-responsive="true"></ins>
      </div>
    </main>
    <script defer src="assets/config.js"></script>
    <script defer src="assets/site.js"></script>
    <script>
      (function () {
        const boardEl = document.getElementById('board');
        const statusEl = document.getElementById('status');
        const resetBtn = document.getElementById('reset');
        const iaStartsInput = document.getElementById('ia-starts');
        const lineEl = document.getElementById('win-line');
        const diffInputs = [...document.querySelectorAll('input[name="diff"]')];
        const symInputs = [...document.querySelectorAll('input[name="sym"]')];
        const winsEl = document.getElementById('wins');
        const lossesEl = document.getElementById('losses');
        const drawsEl = document.getElementById('draws');

        let HUMAN = 'X';
        let AI = 'O';
        const LINES = [
          [0, 1, 2], [3, 4, 5], [6, 7, 8],
          [0, 3, 6], [1, 4, 7], [2, 5, 8],
          [0, 4, 8], [2, 4, 6],
        ];

        let board, isHumanTurn, gameActive, difficulty = 'normal';
        const storage = window.SafeStorage || window.localStorage;
        const stats = JSON.parse((function(){ try { return storage.getItem('ttt_stats') || '{"w":0,"l":0,"d":0}'; } catch(e){ return '{"w":0,"l":0,"d":0}'; } })());
        function syncStats(){ winsEl.textContent=stats.w; lossesEl.textContent=stats.l; drawsEl.textContent=stats.d; try { storage.setItem('ttt_stats', JSON.stringify(stats)); } catch(e){} }
        syncStats();

        function init() {
          board = Array(9).fill(null);
          gameActive = true;
          isHumanTurn = !iaStartsInput.checked;
          lineEl.style.removeProperty('transform'); lineEl.style.removeProperty('--x'); lineEl.style.removeProperty('--y'); lineEl.style.removeProperty('--w');
          render();
          updateStatus(isHumanTurn ? `Votre tour (${HUMAN})` : 'L\'IA joue‚Ä¶');
          if (!isHumanTurn) {
            setTimeout(aiTurn, 400);
          }
        }

        function updateStatus(text) {
          statusEl.textContent = text;
        }

        function render(highlight = []) {
          [...boardEl.children].forEach((btn, i) => {
            btn.innerHTML = board[i] ? `<span class="pop-in">${board[i]}</span>` : '';
            btn.classList.toggle('filled', !!board[i]);
            btn.classList.toggle('win', highlight.includes(i));
            btn.disabled = !gameActive || !!board[i] || !isHumanTurn;
          });
        }

        function getWinner(b) {
          for (const [a, c, d] of LINES) {
            const v = b[a];
            if (v && v === b[c] && v === b[d]) return { player: v, line: [a, c, d] };
          }
          if (b.every(Boolean)) return { player: 'draw', line: [] };
          return null;
        }

        function place(i, s) { board[i] = s; }

        function emptyIndices(b) { return b.map((v, i) => v ? null : i).filter(i => i !== null); }

        function findWinningMove(b, player) {
          for (const i of emptyIndices(b)) {
            b[i] = player;
            const w = getWinner(b);
            b[i] = null;
            if (w && w.player === player) return i;
          }
          return null;
        }

        function aiBestMove(b) {
          if(difficulty==='easy'){
            const opts = emptyIndices(b);
            if(!opts.length) return null;
            // pr√©f√®re centre si dispo, sinon al√©atoire
            if(!b[4]) return 4;
            return opts[Math.floor(Math.random()*opts.length)];
          }
          if(difficulty==='normal'){
            let m = findWinningMove(b, AI); if (m !== null) return m;
            m = findWinningMove(b, HUMAN); if (m !== null) return m;
            if (!b[4]) return 4;
            const corners = [0, 2, 6, 8].filter(i => !b[i]); if (corners.length) return corners[Math.floor(Math.random() * corners.length)];
            const sides = [1, 3, 5, 7].filter(i => !b[i]); if (sides.length) return sides[Math.floor(Math.random() * sides.length)];
            return null;
          }
          // Imbattable (minimax)
          const best = minimax(b.slice(), AI, 0);
          return best.index;
        }

        function minimax(state, player, depth){
          const w = getWinner(state);
          if(w){
            if(w.player===AI) return { score: 10 - depth };
            if(w.player===HUMAN) return { score: depth - 10 };
            return { score: 0 };
          }
          const moves = [];
          for(const i of emptyIndices(state)){
            const move = { index: i };
            state[i] = player;
            if(player===AI){ move.score = minimax(state, HUMAN, depth+1).score; }
            else { move.score = minimax(state, AI, depth+1).score; }
            state[i] = null; moves.push(move);
          }
          if(player===AI){ let max=-Infinity, best=0; for(const m of moves){ if(m.score>max){ max=m.score; best=m.index; } } return { index: best, score: max }; }
          else { let min=Infinity, best=0; for(const m of moves){ if(m.score<min){ min=m.score; best=m.index; } } return { index: best, score: min }; }
        }

        function endGame(winner) {
          gameActive = false;
          if (winner.player === 'draw') { updateStatus('√âgalit√© !'); stats.d++; render(); }
          else if (winner.player === HUMAN) { updateStatus('Bravo, vous gagnez !'); stats.w++; render(winner.line); if(window.SiteUI && window.SiteUI.confetti) window.SiteUI.confetti(); }
          else { updateStatus('L\'ordinateur gagne‚Ä¶'); stats.l++; render(winner.line); }
          syncStats();
          drawWinLine(winner.line);
        }

        function humanClick(e) {
          const i = Number(e.currentTarget.dataset.index);
          if (!gameActive || !isHumanTurn || board[i]) return;
          place(i, HUMAN); buzz(15);
          const w = getWinner(board);
          if (w) return endGame(w);
          isHumanTurn = false;
          updateStatus('L\'IA joue‚Ä¶');
          render();
          setTimeout(aiTurn, 350);
        }

        function aiTurn() {
          if (!gameActive) return;
          const i = aiBestMove(board); if (i !== null) place(i, AI);
          const w = getWinner(board);
          if (w) return endGame(w);
          isHumanTurn = true;
          updateStatus(`Votre tour (${HUMAN})`);
          render();
        }

        function drawWinLine(line){
          if(!line || line.length!==3) return; // draw or ongoing
          const map = {
            '0,1,2': { x: 0, y: 16.66, w: 100, rot: 0 },
            '3,4,5': { x: 0, y: 50,    w: 100, rot: 0 },
            '6,7,8': { x: 0, y: 83.33, w: 100, rot: 0 },
            '0,3,6': { x: 16.66, y: 0, w: 100, rot: 90 },
            '1,4,7': { x: 50,    y: 0, w: 100, rot: 90 },
            '2,5,8': { x: 83.33, y: 0, w: 100, rot: 90 },
            '0,4,8': { x: 0, y: 0, w: 141.4, rot: 45 },
            '2,4,6': { x: 0, y: 100, w: 141.4, rot: -45 },
          };
          const key = line.slice().sort((a,b)=>a-b).join(',');
          const d = map[key]; if(!d) return;
          lineEl.style.setProperty('transform', `rotate(${d.rot}deg)`);
          lineEl.style.setProperty('--x', d.x+'%');
          lineEl.style.setProperty('--y', d.y+'%');
          lineEl.style.setProperty('--w', d.w+'%');
          lineEl.style.setProperty('position','absolute');
          // place pseudo element
          lineEl.style.setProperty('clip-path', 'inset(0)');
          lineEl.style.setProperty('pointer-events','none');
          // use ::after via inline style variables
          const s = document.createElement('style');
          s.textContent = `#win-line::after{ left: var(--x); top: var(--y); width: var(--w); }`;
          document.head.appendChild(s);
        }

        function buzz(ms){ try{ navigator.vibrate && navigator.vibrate(ms); }catch(e){} }

        // Events
        boardEl.querySelectorAll('.ttt-cell').forEach(btn => btn.addEventListener('click', humanClick));
        resetBtn.addEventListener('click', init);
        iaStartsInput.addEventListener('change', init);
        diffInputs.forEach(i=> i.addEventListener('change', ()=>{ difficulty=i.value; init(); }));
        symInputs.forEach(i=> i.addEventListener('change', ()=>{ HUMAN=i.value; AI = (HUMAN==='X'?'O':'X'); init(); }));

        init();
      })();
    </script>
  </body>
  
</html>
